<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BMW E36 Security System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <!-- Leaflet para Mapas -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@300;500&display=swap');
        
        body { font-family: 'Roboto', sans-serif; background-color: #050505; color: #e0e0e0; }
        .bmw-font { font-family: 'Orbitron', sans-serif; }
        
        .btn-control {
            background: linear-gradient(145deg, #1a1a1a, #0d0d0d);
            box-shadow: 5px 5px 10px #050505, -5px -5px 10px #262626;
            transition: all 0.2s ease;
        }
        .btn-control:active {
            box-shadow: inset 5px 5px 10px #050505, inset -5px -5px 10px #262626;
        }
        
        /* Mapa oscuro */
        .leaflet-layer, .leaflet-control-zoom-in, .leaflet-control-zoom-out, .leaflet-control-attribution { filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%); }
        #map { height: 180px; width: 100%; border-radius: 0.75rem; z-index: 0; }

        /* Login */
        #login-screen {
            background-image: linear-gradient(rgba(0,0,0,0.8), rgba(0,0,0,0.9)), url('https://images.unsplash.com/photo-1616455579100-2ceaa4eb2d37?q=80&w=1000&auto=format&fit=crop');
            background-size: cover; background-position: center;
        }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden select-none flex flex-col">

    <!-- LOGIN -->
    <div id="login-screen" class="fixed inset-0 z-50 flex flex-col items-center justify-center text-center p-6 transition-opacity duration-700">
        <div class="mb-8 animate-pulse">
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/4/44/BMW.svg/2048px-BMW.svg.png" alt="BMW Logo" class="w-24 h-24 mx-auto mb-4 drop-shadow-2xl">
        </div>
        <h1 class="text-3xl font-bold text-white mb-2 bmw-font tracking-wider">BMW E36 328i</h1>
        <p class="text-gray-300 text-lg mb-8 font-light">David Lopez</p>
        
        <div class="w-full max-w-xs space-y-4">
            <input type="password" id="pin-code" placeholder="PIN" class="w-full bg-white/10 border border-white/20 rounded-full px-6 py-3 text-center text-white placeholder-gray-400 focus:outline-none focus:border-[#ff9b00] font-mono text-xl">
            <button onclick="attemptLogin()" class="w-full bg-[#ff9b00] hover:bg-[#e68a00] text-black font-bold py-3 rounded-full shadow-lg transform active:scale-95 transition-all">
                INICIAR
            </button>
        </div>
        <p id="login-error" class="text-red-500 mt-4 hidden text-sm">PIN Incorrecto</p>
    </div>

    <!-- APP -->
    <div id="main-app" class="hidden h-full flex flex-col p-4 max-w-md mx-auto w-full relative overflow-y-auto">
        
        <!-- Header Personalizado -->
        <div class="flex justify-between items-center mb-4 border-b border-gray-800 pb-2">
            <div class="flex items-center gap-3">
                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/4/44/BMW.svg/1024px-BMW.svg.png" class="w-6 h-6">
                <div>
                    <div id="connection-status" class="text-xs text-red-500 flex items-center gap-1">
                        <span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span> Offline
                    </div>
                </div>
            </div>
            <div class="text-right">
                <div class="text-sm font-bold text-white bmw-font tracking-wide">BMW E36 328i</div>
                <div class="text-[10px] text-gray-400 uppercase tracking-widest">David Lopez</div>
            </div>
        </div>

        <!-- Dashboard -->
        <div class="bg-[#111] rounded-2xl p-4 border border-gray-800 shadow-2xl mb-4 relative overflow-hidden shrink-0">
            <!-- Silueta de auto blanca en el fondo -->
            <img src="https://cdn-icons-png.flaticon.com/512/55/55283.png" class="absolute top-2 right-2 w-24 h-24 opacity-10 rotate-12" style="filter: invert(1);">
            
            <div class="grid grid-cols-2 gap-4 text-center relative z-10">
                <div class="col-span-2 mb-1">
                    <h1 id="vehicle-mode" class="text-2xl bmw-font text-white mt-1">BLOQUEADO</h1>
                </div>
                <!-- Iconos Estados -->
                <div class="flex justify-center gap-4 col-span-2">
                    <i id="icon-lock" class="fas fa-lock text-xl text-red-500"></i>
                    <i id="icon-acc" class="fas fa-bolt text-xl text-gray-600"></i>
                    <i id="icon-ign" class="fas fa-key text-xl text-gray-600"></i>
                    <i id="icon-engine" class="fas fa-power-off text-xl text-gray-600"></i>
                </div>
            </div>
        </div>

        <!-- Botones Principales -->
        <div class="grid grid-cols-2 gap-3 mb-4 shrink-0">
            <button onclick="sendCommand('DESBLOQUEAR')" class="btn-control rounded-xl p-3 flex flex-col items-center gap-1 group">
                <i class="fas fa-unlock text-xl text-blue-400"></i>
                <span class="text-xs font-bold text-gray-300">ACC / UNLOCK</span>
            </button>
            <button onclick="sendCommand('BLOQUEAR')" class="btn-control rounded-xl p-3 flex flex-col items-center gap-1 group">
                <i class="fas fa-lock text-xl text-red-500"></i>
                <span class="text-xs font-bold text-gray-300">BLOQUEAR</span>
            </button>
            <button onclick="sendCommand('IGNICION')" class="btn-control rounded-xl p-3 flex flex-col items-center gap-1 group">
                <i class="fas fa-key text-xl text-green-400"></i>
                <span class="text-xs font-bold text-gray-300">IGNICION</span>
            </button>
            <button onclick="sendCommand('ARRANCAR')" class="btn-control rounded-xl p-3 flex flex-col items-center gap-1 border border-[#ff9b00]/30">
                <i class="fas fa-bolt text-xl text-[#ff9b00]"></i>
                <span class="text-xs font-bold text-[#ff9b00]">START</span>
            </button>
        </div>

        <!-- Mapa -->
        <div class="bg-[#111] rounded-xl border border-gray-800 p-1 mb-4 shrink-0 relative">
            <div id="map"></div>
            <div class="absolute bottom-2 left-2 bg-black/70 px-2 py-1 rounded text-[10px] text-white z-10">
                GPS: <span id="gps-coords-text">Esperando...</span>
            </div>
        </div>

        <!-- Funciones Extra -->
        <div class="grid grid-cols-4 gap-2 pb-6">
             <button onclick="sendCommand('ABRIR_PUERTA')" class="btn-control rounded-xl p-3 flex flex-col items-center justify-center gap-1 border border-blue-500/30">
                <i class="fas fa-door-open text-blue-400"></i> <span class="text-[9px]">PUERTA</span>
            </button>
            
             <button onclick="registrarHuella()" class="btn-control rounded-xl p-3 flex flex-col items-center justify-center gap-1 border border-purple-500/30">
                <i class="fas fa-fingerprint text-purple-400"></i> <span class="text-[9px]">HUELLA</span>
            </button>

            <button onclick="sendCommand('TOGGLE_DATA')" class="btn-control rounded-xl p-3 flex flex-col items-center justify-center gap-1 border border-yellow-500/30">
                <i class="fas fa-wifi text-yellow-400"></i> <span class="text-[9px]">DATOS</span>
            </button>

             <button onclick="sendCommand('APAGAR')" class="bg-red-900/80 rounded-xl p-3 flex flex-col items-center justify-center gap-1 border border-red-500 text-white">
                <i class="fas fa-stop-circle"></i> <span class="text-[9px] font-bold">APAGAR</span>
            </button>
        </div>

    </div>

    <script>
        // --- CONFIGURACIÓN MQTT ---
        const MQTT_BROKER = "broker.hivemq.com";
        const MQTT_PORT = 8884; // SSL WebSockets
        const MQTT_CLIENT_ID = "WebBMW_" + Math.random().toString(16).substr(2, 6);
        const TOPIC_SUB = "vehiculo/estado_json";
        const TOPIC_PUB = "vehiculo/control";

        let client;
        let map, marker;

        function attemptLogin() {
            const pin = document.getElementById('pin-code').value;
            if(pin === "1234" || pin === "") {
                document.getElementById('login-screen').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('main-app').classList.remove('hidden');
                    initMap();
                    connectMQTT();
                }, 700);
            } else document.getElementById('login-error').classList.remove('hidden');
        }

        function initMap() {
            map = L.map('map').setView([-16.5000, -68.1500], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap',
                maxZoom: 19
            }).addTo(map);
            
            // ICONO ROJO DEPORTIVO PARA MEJOR VISIBILIDAD
            const icon = L.icon({ 
                iconUrl: 'https://cdn-icons-png.flaticon.com/512/3097/3097180.png', 
                iconSize: [35, 35], 
                iconAnchor: [17, 17] 
            });
            marker = L.marker([-16.5000, -68.1500], {icon: icon}).addTo(map);
        }

        function updateMap(lat, lon) {
            if(!map || !marker) return;
            const newLatLng = new L.LatLng(lat, lon);
            marker.setLatLng(newLatLng);
            map.panTo(newLatLng);
            document.getElementById('gps-coords-text').innerText = `${lat}, ${lon}`;
        }

        function connectMQTT() {
            console.log("Conectando...");
            client = new Paho.MQTT.Client(MQTT_BROKER, MQTT_PORT, MQTT_CLIENT_ID);
            client.onConnectionLost = onConnectionLost;
            client.onMessageArrived = onMessageArrived;

            const options = {
                useSSL: true,
                timeout: 3,
                onSuccess: onConnect,
                onFailure: (e) => {
                    console.log("Fallo MQTT: " + e.errorMessage);
                    document.getElementById('connection-status').innerText = "Reintentando...";
                    setTimeout(connectMQTT, 5000);
                }
            };
            try { client.connect(options); } catch(e) { console.error(e); }
        }

        function onConnect() {
            console.log("MQTT Online");
            document.getElementById('connection-status').innerHTML = '<span class="w-2 h-2 rounded-full bg-green-500"></span> Online';
            document.getElementById('connection-status').className = "text-xs text-green-500 flex items-center gap-1";
            client.subscribe(TOPIC_SUB);
            sendCommand("GET_STATUS");
        }

        function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) {
                console.log("Perdida conexion: " + responseObject.errorMessage);
                document.getElementById('connection-status').innerHTML = '<span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span> Reconectando...';
                setTimeout(connectMQTT, 5000);
            }
        }

        function sendCommand(cmd) {
            if(!client || !client.isConnected()) return;
            message = new Paho.MQTT.Message(cmd);
            message.destinationName = TOPIC_PUB;
            client.send(message);
            if(navigator.vibrate) navigator.vibrate(40);
        }

        function registrarHuella() {
            if(confirm("El sistema entrará en modo registro. Mire la pantalla OLED y el LCD del auto.")) {
                sendCommand('NUEVA_HUELLA');
            }
        }

        function onMessageArrived(message) {
            try {
                let payload = message.payloadString;
                payload = payload.replace(/'/g, '"');
                console.log("RX:", payload);
                const data = JSON.parse(payload);
                updateDashboard(data);
            } catch (e) { console.error("Error JSON", e); }
        }

        function updateDashboard(data) {
            const modeText = document.getElementById('vehicle-mode');
            const mode = data.mode || "DESCONOCIDO";
            modeText.innerText = mode;
            
            if(mode === "LOCKED") modeText.className = "text-2xl bmw-font text-red-500 mt-1";
            else if(mode === "RUNNING") modeText.className = "text-2xl bmw-font text-[#ff9b00] mt-1 animate-pulse";
            else modeText.className = "text-2xl bmw-font text-white mt-1";

            updateIcon('icon-lock', data.locked, 'text-red-500');
            updateIcon('icon-engine', data.run, 'text-[#ff9b00]');
            updateIcon('icon-acc', data.acc, 'text-blue-400');
            updateIcon('icon-ign', data.ign, 'text-green-400');

            if(data.gps && data.gps.includes(",")) {
                const parts = data.gps.split(",");
                const lat = parseFloat(parts[0]);
                const lon = parseFloat(parts[1]);
                if(!isNaN(lat) && !isNaN(lon)) updateMap(lat, lon);
            }
        }

        function updateIcon(id, isActive, activeClass) {
            const el = document.getElementById(id);
            if(isActive) el.className = `fas ${id.replace('icon-','fa-')} text-xl ${activeClass} drop-shadow-[0_0_8px_rgba(255,255,255,0.6)]`;
            else el.className = `fas ${id.replace('icon-','fa-')} text-xl text-gray-700`;
        }
    </script>
</body>
</html>