<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BMW E36 Security V4.5</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <!-- Leaflet para Mapas -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@300;500;700&display=swap');
        
        body { font-family: 'Roboto', sans-serif; background-color: #080808; color: #e0e0e0; }
        .bmw-font { font-family: 'Orbitron', sans-serif; }
        
        .glass-panel {
            background: rgba(20, 20, 20, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }

        .btn-control {
            background: linear-gradient(145deg, #161616, #0f0f0f);
            border: 1px solid #222;
            box-shadow: 4px 4px 8px #050505, -4px -4px 8px #1f1f1f;
            transition: all 0.15s ease;
        }
        .btn-control:active {
            box-shadow: inset 4px 4px 8px #050505, inset -4px -4px 8px #1f1f1f;
            transform: scale(0.98);
        }
        
        .btn-reset {
            background: linear-gradient(145deg, #2a2a2a, #1a1a1a);
            border: 1px solid #333;
            color: #888;
        }
        .btn-reset:active {
            background: #111;
            border-color: #555;
            color: #fff;
        }
        
        #full-map { height: 100%; width: 100%; z-index: 0; }
        .leaflet-layer, .leaflet-control-zoom-in, .leaflet-control-zoom-out, .leaflet-control-attribution { filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%); }
        
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            transition: transform 0.3s ease-in-out;
            overflow-y: auto;
            background-color: #080808;
            padding-bottom: 80px; /* Espacio para scroll */
        }
        .screen.hidden-right { transform: translateX(100%); }
        
        #login-screen {
            background-image: linear-gradient(rgba(0,0,0,0.85), rgba(0,0,0,0.95)), url('https://images.unsplash.com/photo-1616455579100-2ceaa4eb2d37?q=80&w=1000&auto=format&fit=crop');
            background-size: cover; background-position: center; z-index: 2000;
        }

        .battery-bar-bg { background: #333; height: 6px; border-radius: 3px; overflow: hidden; }
        .battery-bar-fill { height: 100%; transition: width 0.5s ease, background-color 0.5s ease; }

        /* Toast CSS Standard */
        #toast-notification {
            transform: translateY(-150%);
            transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        #toast-notification.show { transform: translateY(0); }
        
        .toast-success { border-left-color: #3b82f6; }
        .toast-success i { color: #3b82f6; }
        .toast-danger { border-left-color: #ef4444; }
        .toast-danger i { color: #ef4444; }
        .toast-info { border-left-color: #f59e0b; }
        .toast-info i { color: #f59e0b; }

        .leaflet-popup-content-wrapper, .leaflet-popup-tip {
            background: #1a1a1a; color: white; border: 1px solid #333;
        }
        .leaflet-popup-content { margin: 10px; font-size: 11px; }

        ::-webkit-scrollbar { width: 0px; background: transparent; }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden select-none relative bg-black">

    <!-- TOAST -->
    <div id="toast-notification" class="absolute top-4 left-4 right-4 z-[3000] glass-panel rounded-xl p-4 border-l-4 flex items-center gap-4 shadow-2xl toast-success">
        <div class="w-10 h-10 rounded-full bg-white/5 flex items-center justify-center shrink-0">
            <i id="toast-icon" class="fas fa-face-smile text-xl"></i>
        </div>
        <div>
            <h4 id="toast-title" class="text-xs font-bold uppercase tracking-widest">Notificación</h4>
            <p id="toast-message" class="text-sm text-white font-medium">Mensaje del sistema</p>
        </div>
    </div>

    <!-- LOGIN -->
    <div id="login-screen" class="absolute inset-0 flex flex-col items-center justify-center text-center p-6 transition-opacity duration-700">
        <div class="mb-8 animate-pulse">
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/4/44/BMW.svg/2048px-BMW.svg.png" alt="BMW Logo" class="w-24 h-24 mx-auto mb-4 drop-shadow-2xl">
        </div>
        <h1 class="text-3xl font-bold text-white mb-2 bmw-font tracking-wider">BMW E36</h1>
        <p class="text-gray-400 text-sm mb-8 tracking-[0.2em]">CONNECTED DRIVE V4.5</p>
        <div class="w-full max-w-xs space-y-4">
            <input type="password" id="pin-code" placeholder="ACCESS CODE" class="w-full bg-white/5 border border-white/10 rounded-full px-6 py-4 text-center text-white placeholder-gray-500 focus:outline-none focus:border-[#ff9b00] font-mono text-xl tracking-widest transition-colors">
            <button onclick="attemptLogin()" class="w-full bg-[#ff9b00] hover:bg-[#e68a00] text-black font-bold py-4 rounded-full shadow-lg transform active:scale-95 transition-all tracking-wider">UNLOCK SYSTEM</button>
        </div>
        <p id="login-error" class="text-red-500 mt-4 hidden text-xs uppercase tracking-widest">Access Denied</p>
    </div>

    <!-- PANTALLA 1: DASHBOARD PRINCIPAL -->
    <div id="dashboard-screen" class="screen flex flex-col p-4">
        <!-- Header -->
        <div class="flex justify-between items-center mb-6 shrink-0">
            <div class="flex items-center gap-3">
                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/4/44/BMW.svg/1024px-BMW.svg.png" class="w-8 h-8 drop-shadow-md">
                <div id="connection-status" class="text-[10px] text-gray-500 flex items-center gap-1.5 uppercase font-bold tracking-wider bg-white/5 px-2 py-1 rounded-full">
                    <span class="w-1.5 h-1.5 rounded-full bg-red-500 animate-pulse"></span> Offline
                </div>
            </div>
            <div class="text-right">
                <div class="text-xs font-bold text-white bmw-font tracking-widest">328i SECURITY</div>
            </div>
        </div>

        <!-- Dashboard Status -->
        <div class="glass-panel rounded-3xl p-5 mb-5 relative overflow-hidden shrink-0">
            <div class="absolute -right-4 -top-4 w-32 h-32 bg-blue-900/20 rounded-full blur-3xl"></div>
            <div class="absolute -left-4 -bottom-4 w-32 h-32 bg-red-900/10 rounded-full blur-3xl"></div>
            
            <div class="relative z-10">
                <div class="text-center mb-6">
                    <div class="text-[10px] text-gray-500 uppercase tracking-[0.3em] mb-1">Vehicle Status</div>
                    <h1 id="vehicle-mode" class="text-3xl bmw-font text-white font-bold tracking-wide drop-shadow-lg">LOCKED</h1>
                </div>
                
                <div class="flex justify-center gap-8 mb-6">
                    <div class="flex flex-col items-center gap-1">
                        <i id="icon-lock" class="fas fa-lock text-xl text-gray-700 transition-all duration-300"></i>
                        <span class="text-[8px] text-gray-600 uppercase">Lock</span>
                    </div>
                    <div class="flex flex-col items-center gap-1">
                        <i id="icon-acc" class="fas fa-bolt text-xl text-gray-700 transition-all duration-300"></i>
                        <span class="text-[8px] text-gray-600 uppercase">ACC</span>
                    </div>
                    <div class="flex flex-col items-center gap-1">
                        <i id="icon-ign" class="fas fa-key text-xl text-gray-700 transition-all duration-300"></i>
                        <span class="text-[8px] text-gray-600 uppercase">IGN</span>
                    </div>
                    <div class="flex flex-col items-center gap-1">
                        <i id="icon-engine" class="fas fa-power-off text-xl text-gray-700 transition-all duration-300"></i>
                        <span class="text-[8px] text-gray-600 uppercase">Run</span>
                    </div>
                </div>

                <div class="bg-black/40 rounded-xl p-3 border border-white/5">
                    <div class="flex justify-between items-center mb-1">
                        <div class="flex items-center gap-2">
                            <i id="batt-icon" class="fas fa-car-battery text-gray-400 text-xs"></i>
                            <span class="text-xs text-gray-300 font-medium">Batería</span>
                        </div>
                        <span id="batt-val" class="text-sm font-bold text-white bmw-font">--.- V</span>
                    </div>
                    <div class="battery-bar-bg mb-1">
                        <div id="batt-bar" class="battery-bar-fill bg-gray-600" style="width: 0%"></div>
                    </div>
                    <div class="flex justify-between">
                        <span id="batt-status-text" class="text-[9px] text-gray-500 uppercase tracking-wider">Sin Datos</span>
                        <span class="text-[9px] text-gray-600">12V System</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Botón Grande MAPA -->
        <button onclick="showMapScreen()" class="glass-panel w-full p-4 rounded-2xl mb-6 flex items-center justify-between group active:bg-white/5 transition-all border border-blue-500/30">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 rounded-full bg-blue-900/30 flex items-center justify-center">
                    <i class="fas fa-map-location-dot text-2xl text-blue-400"></i>
                </div>
                <div class="text-left">
                    <div class="text-sm font-bold text-white tracking-wide">MAPA Y RASTREO GPS</div>
                    <div class="text-[10px] text-gray-400">Ver ubicación en tiempo real e historial</div>
                </div>
            </div>
            <i class="fas fa-chevron-right text-gray-500 group-active:translate-x-1 transition-transform"></i>
        </button>

        <!-- Botones Control -->
        <div class="grid grid-cols-2 gap-3 mb-6 shrink-0">
            <button onclick="sendCommand('DESBLOQUEAR')" class="btn-control rounded-2xl p-4 flex flex-col items-center gap-2 group active:border-blue-500/50">
                <div class="w-10 h-10 rounded-full bg-blue-900/20 flex items-center justify-center">
                    <i class="fas fa-unlock text-xl text-blue-400"></i>
                </div>
                <span class="text-[10px] font-bold text-gray-300 tracking-wider">UNLOCK</span>
            </button>
            <button onclick="sendCommand('BLOQUEAR')" class="btn-control rounded-2xl p-4 flex flex-col items-center gap-2 group active:border-red-500/50">
                <div class="w-10 h-10 rounded-full bg-red-900/20 flex items-center justify-center">
                    <i class="fas fa-lock text-xl text-red-500"></i>
                </div>
                <span class="text-[10px] font-bold text-gray-300 tracking-wider">LOCK</span>
            </button>
            <button onclick="sendCommand('IGNICION')" class="btn-control rounded-2xl p-4 flex flex-col items-center gap-2 group active:border-green-500/50">
                <div class="w-10 h-10 rounded-full bg-green-900/20 flex items-center justify-center">
                    <i class="fas fa-key text-xl text-green-400"></i>
                </div>
                <span class="text-[10px] font-bold text-gray-300 tracking-wider">IGNITION</span>
            </button>
            <button onclick="sendCommandWithConfirm('ARRANCAR', '¿CONFIRMAR ARRANQUE?')" class="btn-control rounded-2xl p-4 flex flex-col items-center gap-2 border border-[#ff9b00]/30 active:bg-[#ff9b00]/10">
                <div class="w-10 h-10 rounded-full bg-orange-900/20 flex items-center justify-center shadow-[0_0_10px_rgba(255,155,0,0.2)]">
                    <i class="fas fa-bolt text-xl text-[#ff9b00]"></i>
                </div>
                <span class="text-[10px] font-bold text-[#ff9b00] tracking-wider">START</span>
            </button>
        </div>

        <!-- Llave Manual -->
        <div class="mb-6">
            <h3 class="text-[10px] text-gray-500 uppercase tracking-widest mb-3 pl-1">Control Físico (Llave)</h3>
            <div class="glass-panel rounded-2xl p-4 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div id="key-status-indicator" class="w-10 h-10 rounded-full bg-gray-800 flex items-center justify-center border border-gray-700">
                        <i class="fas fa-shield-halved text-gray-500" id="key-icon-inner"></i>
                    </div>
                    <div>
                        <div class="text-xs font-bold text-white tracking-wide">LLAVE MANUAL</div>
                        <div id="key-status-text" class="text-[9px] text-gray-500 uppercase tracking-wider">Deshabilitada</div>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="sendCommandWithConfirm('ENABLE_KEY_LOGIC', '¿Habilitar llave física?')" class="bg-gray-800 hover:bg-gray-700 text-white px-3 py-2 rounded-lg text-[10px] font-bold border border-gray-700">ON</button>
                    <button onclick="sendCommandWithConfirm('DISABLE_KEY_LOGIC', '¿Deshabilitar llave física?')" class="bg-gray-800 hover:bg-gray-700 text-white px-3 py-2 rounded-lg text-[10px] font-bold border border-gray-700">OFF</button>
                </div>
            </div>
        </div>

        <!-- Sistemas -->
        <div class="mb-6">
            <h3 class="text-[10px] text-gray-500 uppercase tracking-widest mb-3 pl-1">Sistemas</h3>
            <div class="grid grid-cols-3 gap-3">
                <div class="glass-panel rounded-xl p-3 flex flex-col items-center gap-2">
                    <div class="flex justify-between w-full items-start">
                        <i class="fas fa-wifi text-sm text-gray-400"></i>
                        <div id="wifi-dot" class="w-1.5 h-1.5 rounded-full bg-gray-600"></div>
                    </div>
                    <span class="text-[9px] font-bold text-gray-300 mt-1">CAM WIFI</span>
                    <div class="flex gap-1 w-full mt-1">
                        <button onclick="sendCommand('CMD_WIFI_ON')" class="flex-1 bg-white/5 hover:bg-white/10 rounded py-1 text-[8px] text-green-400">ON</button>
                        <button onclick="sendCommand('CMD_WIFI_OFF')" class="flex-1 bg-white/5 hover:bg-white/10 rounded py-1 text-[8px] text-red-400">OFF</button>
                    </div>
                </div>
                <div class="glass-panel rounded-xl p-3 flex flex-col items-center gap-2">
                    <div class="flex justify-between w-full items-start">
                        <i class="fas fa-satellite-dish text-sm text-gray-400"></i>
                        <div id="gps-dot" class="w-1.5 h-1.5 rounded-full bg-gray-600"></div>
                    </div>
                    <span class="text-[9px] font-bold text-gray-300 mt-1">GPS MOD</span>
                    <div class="flex gap-1 w-full mt-1">
                        <button onclick="sendCommand('CMD_GPS_ON')" class="flex-1 bg-white/5 hover:bg-white/10 rounded py-1 text-[8px] text-green-400">ON</button>
                        <button onclick="sendCommand('CMD_GPS_OFF')" class="flex-1 bg-white/5 hover:bg-white/10 rounded py-1 text-[8px] text-red-400">OFF</button>
                    </div>
                </div>
                <div class="glass-panel rounded-xl p-3 flex flex-col items-center gap-2">
                    <div class="flex justify-between w-full items-start">
                        <i class="fas fa-tv text-sm text-gray-400"></i>
                        <div class="w-1.5 h-1.5 rounded-full bg-blue-500 shadow-[0_0_5px_blue]"></div>
                    </div>
                    <span class="text-[9px] font-bold text-gray-300 mt-1">DISPLAYS</span>
                    <div class="flex gap-1 w-full mt-1">
                        <button onclick="sendCommand('DISPLAY_ON_ALL')" class="flex-1 bg-white/5 hover:bg-white/10 rounded py-1 text-[8px] text-blue-400">ON</button>
                        <button onclick="sendCommand('DISPLAY_OFF_ALL')" class="flex-1 bg-white/5 hover:bg-white/10 rounded py-1 text-[8px] text-gray-400">OFF</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mantenimiento -->
        <div class="mb-6">
            <h3 class="text-[10px] text-gray-500 uppercase tracking-widest mb-3 pl-1">Recuperación</h3>
            <div class="grid grid-cols-3 gap-3">
                <button onclick="sendCommandWithConfirm('ENABLE_CAM', '¿Reiniciar Cámara?')" class="bg-white/5 border border-white/10 rounded-xl p-2 flex flex-col items-center gap-1 active:bg-white/10">
                    <i class="fas fa-video-slash text-gray-400"></i>
                    <span class="text-[7px] text-gray-400">RESET CAM</span>
                </button>
                <button onclick="sendCommandWithConfirm('ENABLE_FINGER', '¿Reiniciar Huella?')" class="bg-white/5 border border-white/10 rounded-xl p-2 flex flex-col items-center gap-1 active:bg-white/10">
                    <i class="fas fa-fingerprint text-gray-400"></i>
                    <span class="text-[7px] text-gray-400">RESET FP</span>
                </button>
                <button onclick="sendCommandWithConfirm('DISPLAY_ON_ALL', '¿Reiniciar Displays?')" class="bg-white/5 border border-white/10 rounded-xl p-2 flex flex-col items-center gap-1 active:bg-white/10">
                    <i class="fas fa-tv text-gray-400"></i>
                    <span class="text-[7px] text-gray-400">RESET LCD</span>
                </button>
            </div>
        </div>

        <!-- Kill Switch -->
        <div class="pb-6">
             <button onclick="sendCommandWithConfirm('APAGAR', '¡ADVERTENCIA! ¿CORTAR ENCENDIDO?')" class="w-full bg-gradient-to-br from-red-900 to-red-950 rounded-xl p-3 flex items-center justify-center gap-2 border border-red-800 shadow-[0_0_15px_rgba(255,0,0,0.2)] active:scale-95 transition-all">
                <i class="fas fa-stop-circle text-white text-lg"></i> 
                <span class="text-xs font-bold text-white tracking-widest">KILL SWITCH - CORTE EMERGENCIA</span>
            </button>
        </div>
    </div>

    <!-- PANTALLA 2: MAPA FULL SCREEN -->
    <div id="map-screen" class="screen hidden-right flex flex-col relative bg-[#111]">
        <!-- Header Mapa -->
        <div class="absolute top-0 left-0 right-0 z-[1001] p-4 bg-gradient-to-b from-black/90 to-transparent pointer-events-none flex justify-between items-start">
            <button onclick="hideMapScreen()" class="pointer-events-auto bg-black/60 backdrop-blur-md w-10 h-10 rounded-full flex items-center justify-center border border-white/10 text-white shadow-lg active:scale-95 transition-transform">
                <i class="fas fa-arrow-left"></i>
            </button>
            
            <div class="pointer-events-auto flex flex-col gap-2">
                 <div class="glass-panel px-3 py-2 rounded-lg flex items-center gap-2 border border-white/10 shadow-lg">
                    <i class="fas fa-satellite text-blue-400 text-xs"></i>
                    <span id="map-coords" class="text-[10px] text-white font-mono">Esperando...</span>
                 </div>
            </div>
        </div>

        <!-- Controles Mapa Flotantes -->
        <div class="absolute bottom-6 left-4 right-4 z-[1001] flex flex-col gap-3 pointer-events-none">
            <!-- Botones Historial -->
            <div class="grid grid-cols-2 gap-3 pointer-events-auto">
                <button onclick="sendCommand('GET_HISTORY_LAST_50')" class="bg-black/70 backdrop-blur-md border border-white/20 text-white py-3 rounded-xl text-xs font-bold flex items-center justify-center gap-2 active:bg-blue-900/50">
                    <i class="fas fa-clock-rotate-left text-blue-400"></i> ÚLTIMOS 50
                </button>
                <button onclick="sendCommand('GET_HISTORY_ALL')" class="bg-black/70 backdrop-blur-md border border-white/20 text-white py-3 rounded-xl text-xs font-bold flex items-center justify-center gap-2 active:bg-purple-900/50">
                    <i class="fas fa-route text-purple-400"></i> RECORRIDO TOTAL
                </button>
            </div>
             <button onclick="clearMapHistory()" class="pointer-events-auto w-full bg-red-900/80 backdrop-blur-md border border-red-500/30 text-white py-3 rounded-xl text-xs font-bold flex items-center justify-center gap-2 active:bg-red-800">
                <i class="fas fa-trash"></i> LIMPIAR MAPA
            </button>
        </div>

        <!-- El Mapa -->
        <div id="full-map"></div>
    </div>

    <script>
        const MQTT_BROKER = "broker.hivemq.com";
        const MQTT_PORT = 8884; 
        const MQTT_CLIENT_ID = "WebBMW_" + Math.random().toString(16).substr(2, 6);
        const TOPIC_SUB_STATUS = "vehiculo/estado_json";
        const TOPIC_SUB_HIST = "vehiculo/historial";
        const TOPIC_PUB = "vehiculo/control";

        let client;
        let map, marker, polyline;
        let pathCoords = [];
        let isMapInit = false;
        let historyLayerGroup; 

        function attemptLogin() {
            const pin = document.getElementById('pin-code').value;
            if(pin === "1234" || pin === "") {
                document.getElementById('login-screen').style.opacity = '0';
                
                // --- CAMBIO CLAVE V4.5: INICIAR CONEXION ANTES QUE EL MAPA ---
                connectMQTT(); // Conectar MQTT primero

                setTimeout(() => {
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('main-app').classList.remove('hidden');
                    
                    // Inicializar mapa de forma segura
                    try {
                       initFullMap();
                    } catch(e) {
                       console.error("Mapa Error:", e);
                    }
                }, 700);
            } else {
                document.getElementById('login-error').classList.remove('hidden');
            }
        }

        // --- NAVEGACIÓN PANTALLAS ---
        function showMapScreen() {
            const dashboard = document.getElementById('dashboard-screen');
            const mapScreen = document.getElementById('map-screen');
            
            // Animación
            dashboard.style.transform = "translateX(-30%)";
            dashboard.style.opacity = "0";
            mapScreen.classList.remove('hidden-right');
            
            if(!isMapInit) {
                // Si no se inició al login, intentar de nuevo
                setTimeout(initFullMap, 300);
            } else {
                setTimeout(() => { if(map) map.invalidateSize(); }, 300);
            }
        }

        function hideMapScreen() {
            const dashboard = document.getElementById('dashboard-screen');
            const mapScreen = document.getElementById('map-screen');
            
            dashboard.style.transform = "translateX(0)";
            dashboard.style.opacity = "1";
            mapScreen.classList.add('hidden-right');
        }

        // --- MAPA LEAFLET ---
        function initFullMap() {
            if(map || isMapInit) return; 
            
            map = L.map('full-map', { zoomControl: false }).setView([-16.5000, -68.1500], 15);
            
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap &copy; CARTO',
                maxZoom: 20
            }).addTo(map);

            const carIcon = L.icon({ 
                iconUrl: 'https://cdn-icons-png.flaticon.com/512/3097/3097180.png', 
                iconSize: [40, 40], iconAnchor: [20, 20] 
            });
            marker = L.marker([-16.5000, -68.1500], {icon: carIcon, zIndexOffset: 1000}).addTo(map);

            polyline = L.polyline([], {
                color: '#ff9b00', 
                weight: 4, 
                dashArray: '10, 10', 
                opacity: 0.8
            }).addTo(map);

            historyLayerGroup = L.layerGroup().addTo(map);
            isMapInit = true;
        }

        function updateMap(lat, lon) {
            if(!map) return;
            const newLatLng = new L.LatLng(lat, lon);
            marker.setLatLng(newLatLng);
            // Solo centrar si no estamos viendo historial activamente
            if(pathCoords.length === 0) map.panTo(newLatLng);
            
            document.getElementById('map-coords').innerText = `${lat.toFixed(5)}, ${lon.toFixed(5)}`;
        }

        function addToHistory(lat, lon, timestamp) {
            if(!map) return;
            
            const latlng = [lat, lon];
            pathCoords.push(latlng);
            polyline.setLatLngs(pathCoords);

            const dateObj = new Date(timestamp * 1000);
            // *** CORRECCIÓN ZONA HORARIA ***
            // Como el ESP32 ya mandó la hora corregida (ej: UTC -4), mostramos la hora UTC directa
            // para que el navegador no intente restarle otras 4 horas.
            const dateStr = dateObj.getUTCDate() + "/" + (dateObj.getUTCMonth()+1) + "/" + dateObj.getUTCFullYear() + " " + 
                            dateObj.getUTCHours().toString().padStart(2, '0') + ":" + 
                            dateObj.getUTCMinutes().toString().padStart(2, '0') + ":" + 
                            dateObj.getUTCSeconds().toString().padStart(2, '0');

            const pointMarker = L.circleMarker(latlng, {
                radius: 6, fillColor: "#ff9b00", color: "#fff", weight: 1, opacity: 1, fillOpacity: 0.8
            });

            pointMarker.bindPopup(`
                <div class="text-center">
                    <div class="text-xs text-gray-400 font-bold mb-1">REGISTRO HISTÓRICO</div>
                    <div class="text-sm font-bold text-white">${dateStr}</div>
                    <div class="text-[10px] text-blue-400 mt-1">${lat.toFixed(5)}, ${lon.toFixed(5)}</div>
                </div>
            `);

            historyLayerGroup.addLayer(pointMarker);

            if(pathCoords.length > 1) {
                map.fitBounds(polyline.getBounds(), {padding: [50, 50]});
            } else {
                map.panTo(latlng);
            }
        }

        function clearMapHistory() {
            pathCoords = [];
            if(polyline) polyline.setLatLngs([]);
            if(historyLayerGroup) historyLayerGroup.clearLayers();
            showNotification("MAPA LIMPIO", "Visualización reseteada", 'info');
        }

        // --- MQTT CONFIGURACIÓN (RESTAURADA V3.4) ---
        function connectMQTT() {
            // Feedback Visual Inmediato
            const st = document.getElementById('connection-status');
            st.innerHTML = '<span class="w-1.5 h-1.5 rounded-full bg-yellow-500 animate-pulse"></span> CONECTANDO...';
            st.classList.remove('text-red-500'); st.classList.add('text-yellow-500');

            console.log("Conectando...");
            // Constructor V3.4 (Sin path extra)
            client = new Paho.MQTT.Client(MQTT_BROKER, MQTT_PORT, MQTT_CLIENT_ID);
            client.onConnectionLost = onConnectionLost;
            client.onMessageArrived = onMessageArrived;

            const options = {
                useSSL: true, 
                timeout: 3,
                onSuccess: onConnect,
                onFailure: (e) => {
                    console.log("Fallo MQTT", e);
                    const st = document.getElementById('connection-status');
                    st.innerHTML = '<span class="w-1.5 h-1.5 rounded-full bg-red-500"></span> RETRYING';
                    st.classList.remove('text-yellow-500'); st.classList.add('text-red-500');
                    setTimeout(connectMQTT, 5000);
                }
            };
            try { client.connect(options); } catch(e) { console.error(e); }
        }

        function onConnect() {
            console.log("MQTT Online");
            const st = document.getElementById('connection-status');
            st.innerHTML = '<span class="w-1.5 h-1.5 rounded-full bg-green-500 shadow-[0_0_5px_#22c55e]"></span> ONLINE';
            st.classList.remove('text-yellow-500'); st.classList.add('text-green-500');
            client.subscribe(TOPIC_SUB_STATUS);
            client.subscribe(TOPIC_SUB_HIST);
            sendCommand("GET_STATUS");
        }

        function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) {
                const st = document.getElementById('connection-status');
                st.innerHTML = '<span class="w-1.5 h-1.5 rounded-full bg-red-500 animate-pulse"></span> RECONNECT';
                st.classList.remove('text-green-500'); st.classList.add('text-red-500');
                setTimeout(connectMQTT, 5000);
            }
        }

        function sendCommand(cmd) {
            if(!client || !client.isConnected()) return;
            const message = new Paho.MQTT.Message(cmd);
            message.destinationName = TOPIC_PUB;
            client.send(message);
            if(navigator.vibrate) navigator.vibrate(30);
        }
        
        function sendCommandWithConfirm(cmd, text) { if(confirm(text)) sendCommand(cmd); }
        function registrarHuella() { if(confirm("¿Iniciar registro de huella?")) sendCommand('NUEVA_HUELLA'); }

        function showNotification(title, message, type = 'info') {
            const toast = document.getElementById('toast-notification');
            const msgEl = document.getElementById('toast-message');
            const titleEl = document.getElementById('toast-title');
            const iconEl = document.getElementById('toast-icon');
            
            toast.className = 'absolute top-4 left-4 right-4 z-[3000] glass-panel rounded-xl p-4 border-l-4 flex items-center gap-4 shadow-2xl';
            if (type === 'error') { toast.classList.add('toast-danger'); iconEl.className = "fas fa-triangle-exclamation text-xl"; } 
            else if (type === 'success') { toast.classList.add('toast-success'); iconEl.className = "fas fa-face-smile text-xl"; } 
            else { toast.classList.add('toast-info'); iconEl.className = "fas fa-circle-info text-xl"; }

            titleEl.innerText = title; msgEl.innerText = message;
            toast.classList.add('show');
            setTimeout(() => { toast.classList.remove('show'); }, 4000);
        }

        function onMessageArrived(message) {
            try {
                let payload = message.payloadString.replace(/'/g, '"');
                const data = JSON.parse(payload);

                if (message.destinationName === TOPIC_SUB_STATUS) {
                    if(data.alert) {
                        if(data.alert === "FACE_UNLOCK") showNotification("ACCESO CONCEDIDO", "Usuario: " + (data.user || "?"), 'success');
                        else if(data.alert === "INFO") showNotification("INFO", data.msg, 'info');
                        else showNotification("ALERTA", data.msg || data.alert, 'error');
                    } else {
                        updateDashboard(data);
                    }
                }
                else if (message.destinationName === TOPIC_SUB_HIST) {
                    if(data.lat && data.lon && data.t) {
                        addToHistory(data.lat, data.lon, data.t);
                    }
                }
            } catch (e) { console.error("Error JSON", e); }
        }

        function updateDashboard(data) {
            const modeText = document.getElementById('vehicle-mode');
            modeText.innerText = data.mode || "UNKNOWN";
            
            if(data.mode === "LOCKED") modeText.className = "text-3xl bmw-font text-red-500 font-bold drop-shadow-[0_0_10px_rgba(239,68,68,0.6)]";
            else if(data.mode === "RUNNING") modeText.className = "text-3xl bmw-font text-[#ff9b00] font-bold drop-shadow-[0_0_10px_rgba(255,155,0,0.6)] animate-pulse";
            else modeText.className = "text-3xl bmw-font text-white font-bold";

            updateIcon('icon-lock', 'fa-lock', data.mode === "LOCKED", 'text-red-500');
            updateIcon('icon-acc', 'fa-bolt', (data.mode === "ACC_ON" || data.mode === "IGN_ON" || data.mode === "RUNNING"), 'text-blue-400');
            updateIcon('icon-ign', 'fa-key', (data.mode === "IGN_ON" || data.mode === "RUNNING"), 'text-green-400');
            updateIcon('icon-engine', 'fa-power-off', data.mode === "RUNNING", 'text-[#ff9b00]');

            if(data.gps && data.gps.includes(",")) {
                const parts = data.gps.split(",");
                const lat = parseFloat(parts[0]);
                const lon = parseFloat(parts[1]);
                if(!isNaN(lat) && !isNaN(lon)) updateMap(lat, lon);
            }

             if(data.batt) {
                const v = parseFloat(data.batt);
                const battVal = document.getElementById('batt-val');
                const battBar = document.getElementById('batt-bar');
                const battStat = document.getElementById('batt-status-text');
                const battIcon = document.getElementById('batt-icon');

                battVal.innerText = v.toFixed(1) + " V";
                let pct = Math.max(0, Math.min(100, (v - 11.0) * (100 / 3.5)));
                battBar.style.width = pct + "%";

                if(v < 11.5) {
                    battBar.className = "battery-bar-fill bg-red-600";
                    battVal.className = "text-sm font-bold text-red-500 bmw-font animate-pulse";
                    battStat.innerText = "CRÍTICO";
                    battStat.className = "text-[9px] text-red-500 font-bold";
                    battIcon.className = "fas fa-car-battery text-red-500 animate-bounce";
                } else if (v > 13.0) {
                    battBar.className = "battery-bar-fill bg-green-500";
                    battVal.className = "text-sm font-bold text-green-400 bmw-font";
                    battStat.innerText = (v > 14.8) ? "SOBRECARGA" : "CARGANDO";
                    battStat.className = "text-[9px] text-green-500 font-bold";
                    battIcon.className = "fas fa-car-battery text-green-400";
                } else {
                    battBar.className = "battery-bar-fill bg-blue-400";
                    battVal.className = "text-sm font-bold text-blue-300 bmw-font";
                    battStat.innerText = "STANDBY";
                    battStat.className = "text-[9px] text-blue-300";
                    battIcon.className = "fas fa-car-battery text-blue-400";
                }
            }

            if(data.chapa) {
                const keyInd = document.getElementById('key-status-indicator');
                const keyIcon = document.getElementById('key-icon-inner');
                const keyText = document.getElementById('key-status-text');
                if(data.chapa === "ON") {
                    keyInd.className = "w-10 h-10 rounded-full bg-indigo-900/50 flex items-center justify-center border border-indigo-500 shadow-[0_0_10px_rgba(99,102,241,0.5)]";
                    keyIcon.className = "fas fa-shield-halved text-indigo-400";
                    keyText.innerText = "HABILITADA";
                    keyText.className = "text-[9px] text-indigo-400 font-bold";
                } else {
                    keyInd.className = "w-10 h-10 rounded-full bg-gray-800 flex items-center justify-center border border-gray-700";
                    keyIcon.className = "fas fa-shield-halved text-gray-600";
                    keyText.innerText = "DESHABILITADA";
                    keyText.className = "text-[9px] text-gray-600";
                }
            }
            
            if(data.gps_st) {
                 document.getElementById('gps-dot').className = (data.gps_st === "ON") ? "w-1.5 h-1.5 rounded-full bg-green-500 shadow-[0_0_5px_#22c55e]" : "w-1.5 h-1.5 rounded-full bg-gray-600";
            }
        }

        function updateIcon(id, iconName, isActive, activeClass) {
            const el = document.getElementById(id);
            if(isActive) el.className = `fas ${iconName} text-xl ${activeClass} drop-shadow-[0_0_8px_rgba(255,255,255,0.4)]`;
            else el.className = `fas ${iconName} text-xl text-gray-700`;
        }
    </script>
</body>
</html>
